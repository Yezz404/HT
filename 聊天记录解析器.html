<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天记录🌙</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 自定义色卡 - Macaron Theme */
        :root {
            --user-bubble: #FCDEA8;
            --assistant-bubble: #FFFFFF;
            --ui-light: #FDEED8;
            --ui-dark: #D2F0EB;
            --action-text: #5a8f7b; /* Darker, accessible green for text */
            --text-main: #333333;
            --text-muted: #777777;
            --sidebar-width: 20%;
        }

        @media (max-width: 1024px) { :root { --sidebar-width: 25%; } }
        @media (max-width: 767px) { :root { --sidebar-width: 80%; } }

        /* 基础样式 */
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'sans-serif';
            background-color: var(--ui-light);
            color: var(--text-main);
            overflow: hidden;
        }
        
        .action { color: var(--action-text); font-style: italic; }

        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--ui-light); }
        ::-webkit-scrollbar-thumb { background: var(--ui-dark); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #b5dcb4; }

        /* 侧边栏样式 */
        #sidebar {
            width: var(--sidebar-width);
            background-color: var(--ui-dark);
            border-color: #b0d9d2; /* Adjusted border color */
            transition: transform 0.3s ease-in-out, margin-left 0.3s ease-in-out;
            flex-shrink: 0;
        }
        #main-content { transition: width 0.3s ease-in-out; }

        @media (max-width: 767px) {
            #sidebar { position: fixed; height: 100%; z-index: 40; transform: translateX(-100%); }
            #sidebar.open { transform: translateX(0); }
        }
        
        @media (min-width: 768px) {
            #sidebar { position: relative; transform: translateX(0); }
            #sidebar.collapsed { margin-left: calc(-1 * var(--sidebar-width)); }
            #main-content.sidebar-collapsed { width: 100%; }
        }

        .sidebar-item.active { background-color: #e7f5f3; font-weight: 600; }
        .sidebar-item { display: flex; align-items: center; position: relative; user-select: none; }
        .sidebar-item-title { flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-right: 8px; cursor: pointer; }

        /* 消息布局 */
        .message-container { display: flex; margin-bottom: 16px; gap: 12px; align-items: flex-start; transition: background-color 0.5s ease-out; border-radius: 8px; padding: 4px; }
        .message-container.highlight { background-color: var(--ui-dark); }
        .avatar { width: 40px; height: 40px; border-radius: 9999px; flex-shrink: 0; }
        .message-content-wrapper { display: flex; flex-direction: column; max-width: calc(100% - 52px); }
        .chat-name { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
        .message-container.user { justify-content: flex-end; }
        .message-container.user .chat-name { text-align: right; }
        .message-container.user .message-content-wrapper { align-items: flex-end; }
        .message-container.assistant { justify-content: flex-start; }
        .message-bubble { position: relative; }

        /* --- 拖拽功能样式 --- */
        .drag-handle {
            opacity: 0;
            cursor: grab;
            padding: 8px 4px;
            margin-right: 4px;
            transition: opacity 0.2s ease-in-out;
            color: var(--text-muted);
            touch-action: none;
        }
        .sidebar-item:hover .drag-handle { opacity: 0.6; }
        .drag-handle:hover { opacity: 1; }
        .sidebar-item.dragging {
            opacity: 0.5;
            background-color: var(--ui-dark);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* --- 气泡收藏功能样式 --- */
        .favorite-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            transform: scale(0.8);
            background-color: white;
            border-radius: 50%;
            padding: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .message-bubble:hover .favorite-btn {
            opacity: 1;
            transform: scale(1);
        }
        .favorite-btn.favorited svg {
            fill: #FCDEA8; /* Use new theme yellow */
            color: #FCDEA8;
        }
        .favorite-item {
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
        }
        .favorite-item:hover { background-color: #e7f5f3; }
        .favorite-item-content {
            color: var(--text-main);
            margin-bottom: 4px;
        }
        .favorite-item-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* 时间戳 */
        .chat-timestamp { text-align: center; margin: 16px 0; }
        .chat-timestamp span {
            background-color: #e5e7eb; color: #6b7280;
            font-size: 0.75rem; padding: 2px 8px; border-radius: 4px;
        }
        
        /* 分支切换器 */
        .branch-switcher { display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 8px; }
        .branch-switcher button { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: var(--action-text); }
        .branch-switcher button:disabled { color: #b0d9d2; cursor: not-allowed; }
        .branch-switcher span { font-size: 0.8rem; color: var(--text-muted); background-color: #0000000d; padding: 2px 6px; border-radius: 4px; }
        
        /* 动作菜单 */
        .actions-menu-btn { cursor: pointer; padding: 4px; border-radius: 4px; }
        .actions-menu-btn:hover { background-color: #0000001a; }
        .actions-menu {
            position: absolute; background-color: white; border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 4px; z-index: 50;
        }
        .actions-menu button { display: flex; align-items: center; gap: 8px; width: 100%; text-align: left; padding: 8px 12px; font-size: 0.875rem; border-radius: 4px; }
        .actions-menu button:hover { background-color: #f3f4f6; }
        
        /* 多选模式 */
        .sidebar-item.selected { background-color: var(--action-text) !important; color: white; }
        .selection-checkbox { margin-right: 12px; width: 18px; height: 18px; accent-color: var(--ui-light); }

        /* 全局搜索样式 */
        #search-results-container {
            position: absolute; top: 110px; right: 24px; width: 320px;
            max-height: 400px; overflow-y: auto;
            background-color: white; border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            z-index: 100;
        }
        .search-result-item { padding: 12px; border-bottom: 1px solid #f3f4f6; cursor: pointer; }
        .search-result-item:hover { background-color: #e7f5f3; }
        .search-result-title { font-weight: 600; color: var(--text-main); }
        .search-result-snippet { font-size: 0.875rem; color: var(--text-muted); margin-top: 4px; }
        .search-result-snippet strong { color: var(--action-text); }

        /* 自定义模态框样式 */
        .modal-overlay {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.5);
            display: none;
            align-items: center; justify-content: center; z-index: 100;
        }
        .modal {
            background-color: white; padding: 24px; border-radius: 8px;
            width: 90%; max-width: 400px; text-align: center;
        }
    </style>
</head>
<body class="antialiased">

    <div class="flex h-screen w-full relative">
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>
        
        <aside id="sidebar" class="h-full flex flex-col">
            <div class="flex-shrink-0">
                <div id="sidebar-header-normal" class="flex justify-between items-center p-3 border-b" style="border-color: #b0d9d2;">
                    <h2 class="text-lg font-bold" style="color: var(--text-main);">对话列表📚</h2>
                    <div class="flex items-center gap-1">
                        <button id="show-favorites-btn" title="收藏夹📖" class="p-1 rounded-full hover:bg-black/10 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                        </button>
                        <button id="enter-selection-mode-btn" title="批量删除" class="p-1 rounded-full hover:bg-black/10 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                        <button id="sidebar-toggle-collapse" title="收起侧边栏" class="p-1 rounded-full hover:bg-black/10 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                        </button>
                    </div>
                </div>
                <div id="sidebar-header-favorites" class="hidden justify-between items-center p-3 border-b" style="border-color: #b0d9d2;">
                    <button id="back-to-conversations-btn" class="text-sm font-semibold flex items-center gap-1" style="color: var(--text-main);">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                        返回
                    </button>
                    <h2 class="text-lg font-bold" style="color: var(--text-main);">收藏夹📖</h2>
                    <div class="w-16"></div> </div>
                <div id="sidebar-header-selection" class="hidden justify-between items-center p-3 border-b" style="border-color: #b0d9d2;">
                    <button id="cancel-selection-btn" class="text-sm font-semibold" style="color: var(--text-main);">取消</button>
                    <button id="delete-selection-btn" class="text-sm font-semibold text-red-500">删除</button>
                </div>
            </div>
            <div id="conversation-list" class="flex-1 overflow-y-auto p-2">
                 <p id="sidebar-placeholder" class="text-slate-500 text-center p-4">还没有对话哦，快来开始第一次记录吧！</p>
            </div>
        </aside>

        <div id="main-content" class="flex flex-col flex-1 h-full p-4 md:p-6 relative">
            <header class="border-b pb-4 mb-4 sticky top-0 z-20 flex justify-between items-center" style="background-color: var(--ui-light); border-color: var(--ui-dark);">
                <button id="sidebar-toggle-expand" title="展开侧边栏" class="p-2 rounded-full hover:bg-black/10 transition-colors hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <div class="flex-1">
                    <h1 class="text-2xl md:text-3xl font-bold text-center" style="color: var(--text-main);">聊天记录🌙</h1>
                </div>
                <div class="relative">
                    <button id="settings-btn" class="p-2 rounded-full hover:bg-black/10 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                    <div id="settings-menu" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl p-4 z-20" style="color: var(--text-main);">
                        <div class="space-y-4">
                            <label for="file-upload-menu" class="w-full block font-bold py-2 px-4 rounded-lg cursor-pointer text-center transition-colors duration-200" style="background-color: var(--action-text); color: #ffffff;">
                                导入记录📥
                            </label>
                            <input id="file-upload-menu" type="file" class="hidden" accept=".json">
                            <input id="search-input" type="text" placeholder="在所有对话中搜索🔎" class="w-full bg-white border rounded-lg py-2 px-4 focus:outline-none focus:ring-2 transition-all text-gray-700 placeholder-gray-400" style="border-color: var(--ui-dark); --tw-ring-color: var(--action-text);">
                        </div>
                    </div>
                    <div id="search-results-container" class="hidden"></div>
                </div>
            </header>

            <main id="chat-container" class="flex-1 overflow-y-auto pr-2">
                <div id="initial-message" class="flex flex-col items-center justify-center h-full" style="color: var(--text-muted);">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" /></svg>
                    <p class="text-lg">请先选择一个对话开始吧📂</p>
                    <p class="text-sm mt-1">💭💗</p>
                </div>
            </main>
        </div>
    </div>

    <div id="confirm-modal-overlay" class="modal-overlay">
      <div id="confirm-modal" class="modal">
        <h3 id="confirm-modal-title" class="text-lg font-bold mb-4"></h3>
        <div class="flex justify-center gap-4">
          <button id="confirm-modal-cancel" class="px-4 py-2 bg-gray-200 rounded-lg">取消</button>
          <button id="confirm-modal-ok" class="px-4 py-2 bg-red-500 text-white rounded-lg">确定</button>
        </div>
      </div>
    </div>

    <div id="rename-modal-overlay" class="modal-overlay">
      <div id="rename-modal" class="modal">
        <h3 id="rename-modal-title" class="text-lg font-bold mb-4">更改标题</h3>
        <input id="rename-modal-input" type="text" class="w-full bg-white border rounded-lg py-2 px-4 mb-4 focus:outline-none focus:ring-2 transition-all text-gray-700" style="border-color: var(--ui-dark); --tw-ring-color: var(--action-text);">
        <div class="flex justify-center gap-4">
          <button id="rename-modal-cancel" class="px-4 py-2 bg-gray-200 rounded-lg">取消</button>
          <button id="rename-modal-ok" class="px-4 py-2 text-white rounded-lg" style="background-color: var(--action-text);">确定</button>
        </div>
      </div>
    </div>

    <script>
        // DOM 元素获取
        const fileUpload = document.getElementById('file-upload-menu');
        const searchInput = document.getElementById('search-input');
        const searchResultsContainer = document.getElementById('search-results-container');
        const chatContainer = document.getElementById('chat-container');
        const initialMessage = document.getElementById('initial-message');
        const conversationList = document.getElementById('conversation-list');
        const sidebarPlaceholder = document.getElementById('sidebar-placeholder');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const sidebarToggleCollapse = document.getElementById('sidebar-toggle-collapse');
        const sidebarToggleExpand = document.getElementById('sidebar-toggle-expand');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsMenu = document.getElementById('settings-menu');
        const sidebarHeaderNormal = document.getElementById('sidebar-header-normal');
        const sidebarHeaderFavorites = document.getElementById('sidebar-header-favorites');
        const sidebarHeaderSelection = document.getElementById('sidebar-header-selection');
        const cancelSelectionBtn = document.getElementById('cancel-selection-btn');
        const deleteSelectionBtn = document.getElementById('delete-selection-btn');
        const enterSelectionModeBtn = document.getElementById('enter-selection-mode-btn');
        const showFavoritesBtn = document.getElementById('show-favorites-btn');
        const backToConversationsBtn = document.getElementById('back-to-conversations-btn');

        const userAvatar = '图床位置';
        const assistantAvatar = '图床位置';

        let allConversations = [];
        let currentConversationIndex = -1;
        let selectionMode = false;
        let selectedIndices = new Set();
        let isFavoritesView = false;
        
        // --- IndexedDB 帮助函数 ---
        const DB_NAME = 'chatLogDB';
        const STORE_NAME = 'conversations';
        const DATA_KEY = 'chatLogs';

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };
                request.onsuccess = event => resolve(event.target.result);
                request.onerror = event => reject('IndexedDB error: ' + event.target.errorCode);
            });
        }

        async function saveDataToDB(data) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(data, DATA_KEY);
                request.onsuccess = () => resolve();
                request.onerror = event => reject('Failed to save data: ' + event.target.error);
            });
        }

        async function loadDataFromDB() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(DATA_KEY);
                request.onsuccess = () => resolve(request.result);
                request.onerror = event => reject('Failed to load data: ' + event.target.error);
            });
        }

        // --- 初始化和事件监听 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromStorage();
            setInitialSidebarState();
            setupTouchAndMouseDragListeners();
        });
        fileUpload.addEventListener('change', handleFileSelect);
        searchInput.addEventListener('input', handleGlobalSearch);
        window.addEventListener('resize', setInitialSidebarState);
        showFavoritesBtn.addEventListener('click', showFavoritesView);
        backToConversationsBtn.addEventListener('click', showConversationsView);
        
        // --- 侧边栏控制逻辑 ---
        function showSidebar() {
            if (window.innerWidth < 768) {
                sidebar.classList.add('open');
                sidebarOverlay.classList.remove('hidden');
            } else {
                sidebar.classList.remove('collapsed');
                mainContent.classList.remove('sidebar-collapsed');
                sidebarToggleExpand.classList.add('hidden');
            }
        }

        function hideSidebar() {
            if (window.innerWidth < 768) {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.add('hidden');
            } else {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-collapsed');
                sidebarToggleExpand.classList.remove('hidden');
            }
        }

        function setInitialSidebarState() {
            if (window.innerWidth < 768) {
                hideSidebar();
                sidebarToggleExpand.classList.remove('hidden');
            } else {
                showSidebar();
            }
        }

        sidebarToggleCollapse.addEventListener('click', hideSidebar);
        sidebarToggleExpand.addEventListener('click', showSidebar);
        sidebarOverlay.addEventListener('click', hideSidebar);
        
        settingsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            settingsMenu.classList.toggle('hidden');
            searchResultsContainer.classList.add('hidden');
        });
        document.addEventListener('click', (e) => {
            if (!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) {
                settingsMenu.classList.add('hidden');
            }
            if (!searchResultsContainer.contains(e.target) && e.target !== searchInput) {
                searchResultsContainer.classList.add('hidden');
            }
        });
        
        // --- 核心功能函数 ---
        async function loadDataFromStorage() {
            try {
                const storedData = await loadDataFromDB();
                if (storedData) {
                    const data = JSON.parse(storedData);
                    processAndDisplayData(data);
                }
            } catch (error) {
                console.error("从IndexedDB加载数据失败:", error);
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const dataString = e.target.result;
                    const newData = JSON.parse(dataString);
                    const newConversations = processData(newData);
                    allConversations = allConversations.concat(newConversations);
                    renderConversationList();
                    await updateDB();
                    settingsMenu.classList.add('hidden');
                    if (allConversations.length > 0 && currentConversationIndex === -1) {
                        displayConversation(0);
                    }
                } catch (error) {
                    console.error("处理文件失败:", error);
                    alert("处理文件失败。可能是文件格式错误。");
                }
            };
            reader.readAsText(file);
        }

        async function updateDB() {
            try {
                const dataToSave = allConversations.map(c => ({
                    title: c.title,
                    mapping: c.originalMapping,
                    current_node: c.currentNode,
                    selectedPath: c.selectedPath,
                    isFavorite: c.isFavorite,
                    favorited_messages: Array.from(c.favorited_messages || [])
                }));
                await saveDataToDB(JSON.stringify(dataToSave));
            } catch (error) {
                console.error("更新数据库失败:", error);
            }
        }

        function processAndDisplayData(data) {
            allConversations = processData(data);
            renderConversationList();
            if (allConversations.length > 0) {
                displayConversation(0);
            } else {
                chatContainer.innerHTML = '';
                initialMessage.style.display = 'flex';
                sidebarPlaceholder.style.display = 'block';
            }
        }

        function processData(data) {
            return data.map(convo => ({
                title: convo.title || '无标题对话',
                originalMapping: convo.mapping,
                currentNode: convo.current_node,
                selectedPath: convo.selectedPath || {},
                isFavorite: convo.isFavorite || false,
                favorited_messages: new Set(convo.favorited_messages || [])
            })).filter(convo => convo.originalMapping);
        }

        function renderConversationList() {
            const currentConvoObject = allConversations[currentConversationIndex];
            conversationList.innerHTML = '';
            
            if (selectionMode) {
                sidebarHeaderNormal.style.display = 'none';
                sidebarHeaderFavorites.style.display = 'none';
                sidebarHeaderSelection.style.display = 'flex';
            } else if (isFavoritesView) {
                sidebarHeaderNormal.style.display = 'none';
                sidebarHeaderFavorites.style.display = 'flex';
                sidebarHeaderSelection.style.display = 'none';
            } else {
                sidebarHeaderNormal.style.display = 'flex';
                sidebarHeaderFavorites.style.display = 'none';
                sidebarHeaderSelection.style.display = 'none';
            }

            const favorites = allConversations.filter(c => c.isFavorite);
            const nonFavorites = allConversations.filter(c => !c.isFavorite);

            if (favorites.length > 0) {
                const favHeader = document.createElement('div');
                favHeader.className = 'px-3 py-2 text-xs font-semibold text-gray-500 uppercase';
                favHeader.textContent = '收藏夹📖';
                conversationList.appendChild(favHeader);
                favorites.forEach(convo => {
                    const index = allConversations.indexOf(convo);
                    conversationList.appendChild(createSidebarItem(convo, index));
                });
            }

            if (nonFavorites.length > 0) {
                 const recentHeader = document.createElement('div');
                recentHeader.className = 'px-3 py-2 text-xs font-semibold text-gray-500 uppercase';
                recentHeader.textContent = '最近对话';
                conversationList.appendChild(recentHeader);
                nonFavorites.forEach(convo => {
                    const index = allConversations.indexOf(convo);
                    conversationList.appendChild(createSidebarItem(convo, index));
                });
            }
            
            if (allConversations.length === 0) {
                 sidebarPlaceholder.style.display = 'block';
                 sidebarPlaceholder.textContent = '🔐✨';
            } else {
                 sidebarPlaceholder.style.display = 'none';
            }
            
            currentConversationIndex = allConversations.findIndex(c => c === currentConvoObject);
            updateActiveSidebarItem();
        }

        function createSidebarItem(convo, index) {
            const item = document.createElement('div');
            item.className = 'sidebar-item p-3 my-1 rounded-lg transition-colors duration-150';
            item.dataset.index = index;
            if (selectedIndices.has(index)) item.classList.add('selected');
            
            if (selectionMode) {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'selection-checkbox';
                checkbox.checked = selectedIndices.has(index);
                checkbox.onclick = (e) => { e.stopPropagation(); handleSelectionClick(index); };
                item.appendChild(checkbox);
            } else {
                const handle = document.createElement('span');
                handle.className = 'drag-handle';
                handle.innerHTML = `<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 3C5.55228 3 6 2.55228 6 2C6 1.44772 5.55228 1 5 1C4.44772 1 4 1.44772 4 2C4 2.55228 4.44772 3 5 3Z" fill="currentColor"/><path d="M5 9C5.55228 9 6 8.55228 6 8C6 7.44772 5.55228 7 5 7C4.44772 7 4 7.44772 4 8C4 8.55228 4.44772 9 5 9Z" fill="currentColor"/><path d="M5 15C5.55228 15 6 14.55228 6 14C6 13.4477 5.55228 13 5 13C4.44772 13 4 13.4477 4 14C4 14.55228 4.44772 15 5 15Z" fill="currentColor"/><path d="M11 3C11.5523 3 12 2.55228 12 2C12 1.44772 11.5523 1 11 1C10.4477 1 10 1.44772 10 2C10 2.55228 10.4477 3 11 3Z" fill="currentColor"/><path d="M11 9C11.5523 9 12 8.55228 12 8C12 7.44772 11.5523 7 11 7C10.4477 7 10 7.44772 10 8C10 8.55228 10.4477 9 11 9Z" fill="currentColor"/><path d="M11 15C11.5523 15 12 14.55228 12 14C12 13.4477 11.5523 13 11 13C10.4477 13 10 13.4477 10 14C10 14.55228 10.4477 15 11 15Z" fill="currentColor"/></svg>`;
                item.prepend(handle);
            }

            const titleSpan = document.createElement('span');
            titleSpan.className = 'sidebar-item-title';
            titleSpan.textContent = convo.title;
            
            item.addEventListener('click', (e) => {
                if (e.target.closest('.drag-handle') || e.target.closest('.actions-menu-btn-wrapper')) return;
                if (selectionMode) {
                    handleSelectionClick(index);
                } else {
                    displayConversation(index);
                    if (window.innerWidth < 768) {
                       hideSidebar();
                    }
                }
            });
            item.appendChild(titleSpan);
            
            if (!selectionMode) {
                const menuBtnWrapper = document.createElement('div');
                menuBtnWrapper.className = 'actions-menu-btn-wrapper ml-auto';
                const button = document.createElement('button');
                button.className = 'actions-menu-btn';
                button.innerHTML = '...';
                button.onclick = (e) => {
                    e.stopPropagation();
                    showActionsMenu(e.currentTarget, index);
                };
                menuBtnWrapper.appendChild(button);
                item.appendChild(menuBtnWrapper);
            }
            return item;
        }

        // --- 兼容移动和桌面的拖拽逻辑 ---
        function setupTouchAndMouseDragListeners() {
            let draggedItem = null, startY = 0, currentY = 0, scrollInterval = null;

            function onDragStart(e) {
                const handle = e.target.closest('.drag-handle');
                if (!handle || isFavoritesView) return;
                e.preventDefault(); 
                draggedItem = handle.closest('.sidebar-item');
                draggedItem.classList.add('dragging');
                startY = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY;
                document.addEventListener('mousemove', onDragMove);
                document.addEventListener('touchmove', onDragMove, { passive: false });
                document.addEventListener('mouseup', onDragEnd);
                document.addEventListener('touchend', onDragEnd);
            }

            function onDragMove(e) {
                if (!draggedItem) return;
                e.preventDefault();
                currentY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY;
                const deltaY = currentY - startY;
                draggedItem.style.transform = `translateY(${deltaY}px)`;
                draggedItem.style.zIndex = '100';
                const afterElement = getDragAfterElement(conversationList, currentY);
                if (afterElement == null) {
                    conversationList.appendChild(draggedItem);
                } else {
                    conversationList.insertBefore(draggedItem, afterElement);
                }
                handleAutoScroll(currentY);
            }

            async function onDragEnd() {
                if (!draggedItem) return;
                clearInterval(scrollInterval);
                scrollInterval = null;
                draggedItem.classList.remove('dragging');
                draggedItem.style.transform = '';
                draggedItem.style.zIndex = '';
                document.removeEventListener('mousemove', onDragMove);
                document.removeEventListener('touchmove', onDragMove);
                document.removeEventListener('mouseup', onDragEnd);
                document.removeEventListener('touchend', onDragEnd);
                
                const newConversations = [];
                conversationList.querySelectorAll('.sidebar-item').forEach(item => {
                    newConversations.push(allConversations[parseInt(item.dataset.index)]);
                });
                allConversations = newConversations;
                
                await updateDB();
                renderConversationList();
                draggedItem = null;
            }
            
            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.sidebar-item:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            function handleAutoScroll(y) {
                const listRect = conversationList.getBoundingClientRect();
                const scrollSpeed = 10;
                clearInterval(scrollInterval);
                scrollInterval = null;
                if (y < listRect.top + 50) { 
                    scrollInterval = setInterval(() => { conversationList.scrollTop -= scrollSpeed; }, 20);
                } else if (y > listRect.bottom - 50) {
                    scrollInterval = setInterval(() => { conversationList.scrollTop += scrollSpeed; }, 20);
                }
            }
            conversationList.addEventListener('mousedown', onDragStart);
            conversationList.addEventListener('touchstart', onDragStart, { passive: false });
        }

        function showActionsMenu(button, index) {
            document.querySelector('.actions-menu')?.remove();
            const menu = document.createElement('div');
            menu.className = 'actions-menu';
            const convo = allConversations[index];
            const favBtn = document.createElement('button');
            favBtn.innerHTML = convo.isFavorite ? `<span>⭐</span><span>取消收藏💧</span>` : `<span>☆</span><span>收藏♡</span>`;
            favBtn.onclick = () => { toggleFavorite(index); menu.remove(); };
            const renameBtn = document.createElement('button');
            renameBtn.innerHTML = `<span>✏️</span><span>重命名</span>`;
            renameBtn.onclick = () => { renameConversation(index); menu.remove(); };
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `<span>🗑️</span><span>删除</span>`;
            deleteBtn.onclick = () => { confirmDelete(index); menu.remove(); };
            menu.appendChild(favBtn);
            menu.appendChild(renameBtn);
            menu.appendChild(deleteBtn);
            document.body.appendChild(menu);
            const rect = button.getBoundingClientRect();
            menu.style.top = `${rect.bottom}px`;
            menu.style.left = `${rect.left - menu.offsetWidth + rect.width}px`;
            setTimeout(() => {
                document.addEventListener('click', () => menu.remove(), { once: true });
            }, 0);
        }

        async function toggleFavorite(index) {
            allConversations[index].isFavorite = !allConversations[index].isFavorite;
            await updateDB();
            renderConversationList();
        }

        async function renameConversation(index) {
            const currentTitle = allConversations[index].title;
            showRenameModal("输入新标题:", currentTitle, (newTitle) => {
                if (newTitle && newTitle.trim() !== '') {
                    allConversations[index].title = newTitle.trim();
                    updateDB();
                    renderConversationList();
                }
            });
        }

        function displayConversation(index, scrollTop, highlightId = null) {
            if (index === -1 || index >= allConversations.length) return;
            currentConversationIndex = index;
            const conversation = allConversations[index];
            if (!conversation) return;

            if (highlightId) {
                const newPath = buildPathToNode(conversation.originalMapping, highlightId);
                if (Object.keys(newPath).length > 0) {
                    conversation.selectedPath = newPath;
                    updateDB();
                }
            }

            renderMessages(conversation);
            updateActiveSidebarItem();

            if (highlightId) {
                setTimeout(() => {
                    const targetMessage = chatContainer.querySelector(`[data-message-id="${highlightId}"]`);
                    if (targetMessage) {
                        targetMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetMessage.classList.add('highlight');
                        setTimeout(() => targetMessage.classList.remove('highlight'), 2000);
                    }
                }, 100);
            } else {
                chatContainer.scrollTop = scrollTop || 0;
            }
        }
        
        function renderMessages(conversation) {
            chatContainer.innerHTML = '';
            initialMessage.style.display = 'none';
            const mapping = conversation.originalMapping;
            const path = conversation.selectedPath;
            let rootId = Object.keys(mapping).find(key => mapping[key].parent === null);
            if (!rootId) {
                 chatContainer.innerHTML = `<div class="text-center py-10" style="color: var(--text-muted);">无法渲染此对话。</div>`;
                 return;
            }

            let lastTimestamp = 0;
            let currentNodeId = rootId;

            while(currentNodeId) {
                const nodeId = currentNodeId;
                const node = mapping[nodeId];
                if (!node) break;

                if (node.message) {
                    const msg = node.message;
                    const isValidRole = msg.author.role === 'user' || msg.author.role === 'assistant';
                    const hasContent = msg.content && msg.content.content_type === 'text' && msg.content.parts;
                    const contentText = (hasContent && Array.isArray(msg.content.parts)) ? msg.content.parts.join('') : '';

                    if (isValidRole && contentText.trim() !== '') {
                        if (shouldShowTimestamp(msg.create_time, lastTimestamp)) {
                            const timestampDiv = document.createElement('div');
                            timestampDiv.className = 'chat-timestamp';
                            timestampDiv.innerHTML = `<span>${formatTimestampForWeChatStyle(msg.create_time)}</span>`;
                            chatContainer.appendChild(timestampDiv);
                        }
                        lastTimestamp = msg.create_time;

                        const container = document.createElement('div');
                        container.className = `message-container ${msg.author.role}`;
                        container.dataset.messageId = nodeId;
                        const avatar = document.createElement('img');
                        avatar.className = 'avatar';
                        avatar.src = msg.author.role === 'user' ? userAvatar : assistantAvatar;
                        avatar.onerror = () => { avatar.src = 'https://placehold.co/40x40/ccc/fff?text=?'; };
                        const contentWrapper = document.createElement('div');
                        contentWrapper.className = 'message-content-wrapper';
                        const nameDiv = document.createElement('div');
                        nameDiv.className = 'chat-name';
                        nameDiv.textContent = msg.author.role === 'user' ? '用户' : '助手';
                        const bubble = document.createElement('div');
                        bubble.className = `rounded-lg p-3 max-w-xl message-bubble`;
                        bubble.style.backgroundColor = msg.author.role === 'user' ? 'var(--user-bubble)' : 'var(--assistant-bubble)';
                        
                        const favBtn = document.createElement('button');
                        favBtn.className = 'favorite-btn';
                        const isFavorited = conversation.favorited_messages.has(nodeId);
                        if (isFavorited) favBtn.classList.add('favorited');
                        favBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>`;
                        favBtn.onclick = () => toggleMessageFavorite(nodeId, favBtn);
                        bubble.appendChild(favBtn);

                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'whitespace-pre-wrap';
                        contentDiv.innerHTML = parseSpecialContent(contentText);
                        bubble.appendChild(contentDiv);
                        
                        if (node.children.length > 1) {
                            const switcher = createBranchSwitcher(currentConversationIndex, nodeId, node.children);
                            bubble.appendChild(switcher);
                        }
                        
                        contentWrapper.appendChild(nameDiv);
                        contentWrapper.appendChild(bubble);

                        if (msg.author.role === 'user') {
                            container.appendChild(contentWrapper);
                            container.appendChild(avatar);
                        } else {
                            container.appendChild(avatar);
                            container.appendChild(contentWrapper);
                        }
                        chatContainer.appendChild(container);
                    }
                }

                if (node.children && node.children.length > 0) {
                    const selectedChildIndex = path[nodeId] || 0;
                    currentNodeId = node.children[selectedChildIndex] || node.children[0];
                } else {
                    currentNodeId = null;
                }
            }
        }
        
        function createBranchSwitcher(convoIndex, parentId, children) {
            const switcher = document.createElement('div');
            switcher.className = 'branch-switcher';
            const currentIndex = allConversations[convoIndex].selectedPath[parentId] || 0;
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‹';
            prevBtn.onclick = () => switchBranch(convoIndex, parentId, currentIndex - 1);
            if (currentIndex === 0) prevBtn.disabled = true;
            const indicator = document.createElement('span');
            indicator.textContent = `${currentIndex + 1} / ${children.length}`;
            const nextBtn = document.createElement('button');
            nextBtn.textContent = '›';
            nextBtn.onclick = () => switchBranch(convoIndex, parentId, currentIndex + 1);
            if (currentIndex >= children.length - 1) nextBtn.disabled = true;
            switcher.appendChild(prevBtn);
            switcher.appendChild(indicator);
            switcher.appendChild(nextBtn);
            return switcher;
        }

        async function switchBranch(convoIndex, parentId, newChildIndex) {
            const currentScroll = chatContainer.scrollTop;
            allConversations[convoIndex].selectedPath[parentId] = newChildIndex;
            await updateDB();
            displayConversation(convoIndex, currentScroll);
        }

        function updateActiveSidebarItem() {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                const index = parseInt(item.dataset.index);
                item.classList.toggle('active', index === currentConversationIndex);
            });
        }
        
        // --- 多选与删除功能 ---
        enterSelectionModeBtn.addEventListener('click', enterSelectionMode);
        cancelSelectionBtn.addEventListener('click', exitSelectionMode);
        deleteSelectionBtn.addEventListener('click', () => confirmBulkDelete());

        function enterSelectionMode() {
            if (selectionMode) return;
            selectionMode = true;
            renderConversationList();
        }

        function exitSelectionMode() {
            selectionMode = false;
            selectedIndices.clear();
            renderConversationList();
        }

        function handleSelectionClick(index) {
            if (selectedIndices.has(index)) {
                selectedIndices.delete(index);
            } else {
                selectedIndices.add(index);
            }
            const item = conversationList.querySelector(`[data-index="${index}"]`);
            if (item) {
                item.classList.toggle('selected', selectedIndices.has(index));
                const checkbox = item.querySelector('.selection-checkbox');
                if (checkbox) checkbox.checked = selectedIndices.has(index);
            }
        }
        
        function confirmDelete(index) {
            showConfirmModal(`确定要删除 "${allConversations[index].title}" 吗?`, () => {
                deleteSingleConversation(index);
            });
        }

        function confirmBulkDelete() {
            if (selectedIndices.size === 0) return;
            showConfirmModal(`确定要删除选中的 ${selectedIndices.size} 项对话吗?`, () => {
                deleteBulkConversations();
            });
        }

        async function deleteSingleConversation(index) {
             allConversations.splice(index, 1);
             await updateDB();
             if (currentConversationIndex === index) {
                 currentConversationIndex = Math.max(0, index - 1);
             } else if (currentConversationIndex > index) {
                 currentConversationIndex--;
             }
             renderConversationList();
             if (allConversations.length > 0) {
                 displayConversation(currentConversationIndex);
             } else {
                 chatContainer.innerHTML = '';
                 initialMessage.style.display = 'flex';
                 currentConversationIndex = -1;
             }
        }

        async function deleteBulkConversations() {
            const sortedIndices = Array.from(selectedIndices).sort((a, b) => b - a);
            sortedIndices.forEach(index => allConversations.splice(index, 1));
            await updateDB();
            exitSelectionMode();
            if (allConversations.length > 0) {
                currentConversationIndex = 0;
                displayConversation(0);
            } else {
                chatContainer.innerHTML = '';
                initialMessage.style.display = 'flex';
                currentConversationIndex = -1;
            }
        }

        // --- 收藏夹功能 ---
        function showFavoritesView() {
            isFavoritesView = true;
            renderFavoritesList();
        }

        function showConversationsView() {
            isFavoritesView = false;
            renderConversationList();
        }

        function renderFavoritesList() {
            conversationList.innerHTML = '';
            sidebarHeaderNormal.style.display = 'none';
            sidebarHeaderFavorites.style.display = 'flex';
            sidebarHeaderSelection.style.display = 'none';
            const allFavoriteMessages = [];
            allConversations.forEach((convo, convoIndex) => {
                convo.favorited_messages.forEach(nodeId => {
                    const node = convo.originalMapping[nodeId];
                    if (node && node.message) {
                        allFavoriteMessages.push({
                            convoIndex,
                            nodeId,
                            timestamp: node.message.create_time,
                            content: node.message.content.parts.join(''),
                            convoTitle: convo.title
                        });
                    }
                });
            });
            allFavoriteMessages.sort((a, b) => b.timestamp - a.timestamp);
            if (allFavoriteMessages.length === 0) {
                sidebarPlaceholder.style.display = 'block';
                sidebarPlaceholder.textContent = '还没有收藏任何消息哦！';
            } else {
                sidebarPlaceholder.style.display = 'none';
                allFavoriteMessages.forEach(msg => {
                    const item = document.createElement('div');
                    item.className = 'favorite-item';
                    item.innerHTML = `
                        <div class="favorite-item-content">${parseSpecialContent(msg.content.substring(0, 100))}...</div>
                        <div class="favorite-item-meta">来自: ${msg.convoTitle}</div>
                    `;
                    item.onclick = () => {
                        showConversationsView();
                        displayConversation(msg.convoIndex, null, msg.nodeId);
                         if (window.innerWidth < 768) hideSidebar();
                    };
                    conversationList.appendChild(item);
                });
            }
        }

        async function toggleMessageFavorite(nodeId, buttonElement) {
            const conversation = allConversations[currentConversationIndex];
            if (!conversation) return;
            if (conversation.favorited_messages.has(nodeId)) {
                conversation.favorited_messages.delete(nodeId);
                buttonElement.classList.remove('favorited');
            } else {
                conversation.favorited_messages.add(nodeId);
                buttonElement.classList.add('favorited');
            }
            await updateDB();
            if (isFavoritesView) renderFavoritesList();
        }

        // --- 全局搜索功能 ---
        function handleGlobalSearch() {
            const searchTerm = searchInput.value.trim().toLowerCase();
            if (!searchTerm) {
                searchResultsContainer.classList.add('hidden');
                return;
            }
            const results = [];
            allConversations.forEach((convo, convoIndex) => {
                Object.entries(convo.originalMapping).forEach(([nodeId, node]) => {
                    if (node.message?.content?.parts) {
                        const contentText = node.message.content.parts.join('').toLowerCase();
                        if (contentText.includes(searchTerm)) {
                            results.push({
                                convoIndex,
                                nodeId,
                                title: convo.title,
                                text: node.message.content.parts.join('')
                            });
                        }
                    }
                });
            });
            renderSearchResults(results, searchTerm);
        }

        function renderSearchResults(results, searchTerm) {
            searchResultsContainer.innerHTML = '';
            if (results.length === 0) {
                searchResultsContainer.innerHTML = '<div class="p-4 text-center text-sm text-gray-500">找不到结果</div>';
                searchResultsContainer.classList.remove('hidden');
                return;
            }
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                const title = document.createElement('div');
                title.className = 'search-result-title';
                title.textContent = result.title;
                const snippet = document.createElement('div');
                snippet.className = 'search-result-snippet';
                snippet.innerHTML = createSnippet(result.text, searchTerm);
                item.appendChild(title);
                item.appendChild(snippet);
                item.onclick = () => {
                    displayConversation(result.convoIndex, null, result.nodeId);
                    searchResultsContainer.classList.add('hidden');
                    searchInput.value = '';
                    settingsMenu.classList.add('hidden');
                    if (window.innerWidth < 768) hideSidebar();
                };
                searchResultsContainer.appendChild(item);
            });
            searchResultsContainer.classList.remove('hidden');
        }

        function createSnippet(text, searchTerm) {
            const index = text.toLowerCase().indexOf(searchTerm);
            if (index === -1) return text;
            const start = Math.max(0, index - 20);
            const end = Math.min(text.length, index + searchTerm.length + 20);
            let snippet = text.substring(start, end);
            const regex = new RegExp(searchTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'gi');
            snippet = snippet.replace(regex, (match) => `<strong>${match}</strong>`);
            if (start > 0) snippet = '...' + snippet;
            if (end < text.length) snippet = snippet + '...';
            return snippet;
        }

        // --- 辅助函数 ---
        function showConfirmModal(message, onConfirm) {
            const modalOverlay = document.getElementById('confirm-modal-overlay');
            const modalTitle = document.getElementById('confirm-modal-title');
            const okBtn = document.getElementById('confirm-modal-ok');
            const cancelBtn = document.getElementById('confirm-modal-cancel');
            modalTitle.textContent = message;
            const close = () => {
                modalOverlay.style.display = 'none';
                okBtn.onclick = null; cancelBtn.onclick = null; modalOverlay.onclick = null;
            };
            okBtn.onclick = () => { onConfirm(); close(); };
            cancelBtn.onclick = close;
            modalOverlay.onclick = (e) => { if (e.target === modalOverlay) close(); };
            modalOverlay.style.display = 'flex';
        }
        
        function showRenameModal(title, currentValue, onConfirm) {
            const modalOverlay = document.getElementById('rename-modal-overlay');
            const modalTitle = document.getElementById('rename-modal-title');
            const input = document.getElementById('rename-modal-input');
            const okBtn = document.getElementById('rename-modal-ok');
            const cancelBtn = document.getElementById('rename-modal-cancel');
            modalTitle.textContent = title;
            input.value = currentValue;
            const close = () => {
                modalOverlay.style.display = 'none';
                okBtn.onclick = null; cancelBtn.onclick = null; modalOverlay.onclick = null;
            };
            okBtn.onclick = () => { onConfirm(input.value); close(); };
            cancelBtn.onclick = close;
            modalOverlay.onclick = (e) => { if (e.target === modalOverlay) close(); };
            modalOverlay.style.display = 'flex';
            input.focus();
        }

        function buildPathToNode(mapping, targetId) {
            const path = {};
            let currentId = targetId;
            while (currentId && mapping[currentId]) {
                const parentId = mapping[currentId].parent;
                if (!parentId) break;
                const parentNode = mapping[parentId];
                if (parentNode && parentNode.children) {
                    const childIndex = parentNode.children.indexOf(currentId);
                    if (childIndex !== -1) path[parentId] = childIndex;
                }
                currentId = parentId;
            }
            return path;
        }

        function parseSpecialContent(text) {
            if (typeof text !== 'string') return '';
            let safeText = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            safeText = safeText.replace(/([（(])(.*?)([)）])/g, '<span class="action">$1$2$3</span>');
            return safeText;
        }

        function shouldShowTimestamp(currentTimestamp, lastTimestamp) {
            if (!currentTimestamp || !lastTimestamp) return true;
            return (currentTimestamp - lastTimestamp) > 300; // 5 minutes
        }

        function formatTimestampForWeChatStyle(unixTimestamp) {
            if (!unixTimestamp) return '';
            const date = new Date(unixTimestamp * 1000);
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const timeString = `${hours}:${minutes}`;
            if (date >= today) return timeString;
            if (date >= yesterday) return `昨天 ${timeString}`;
            return `${date.getMonth() + 1}月${date.getDate()}日 ${timeString}`;
        }
    </script>
</body>
</html>